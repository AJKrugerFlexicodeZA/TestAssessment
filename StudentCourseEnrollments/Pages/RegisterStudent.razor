@* Pages/RegisterModal.razor *@
@using MIDTIER.Models
@using StudentCourseEnrollments.Services

@inject NavigationManager Nav
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject JwtAuthenticationStateProvider AuthProvider
@inject StudentCourseEnrollments.Services.APIService Api
@inject NotificationService Notify

<PageTitle>Register User</PageTitle>

<!-- Modal Backdrop -->
<div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50
            d-flex align-items-center justify-content-center z-3">

    <!-- Card -->
    <div class="card shadow-lg border-0 w-100" style="max-width: 420px;">
        <div class="card-body p-4 position-relative">

            <!-- Close Button -->
            <button type="button"
                    class="btn-close position-absolute top-0 end-0 m-3"
                    @onclick="OnClose">
            </button>

            <!-- Title -->
            <h2 class="text-center fw-bold mb-4">
                Create Account
            </h2>

            <EditForm Model="registerModel" OnValidSubmit="RegisterAsync">
                <DataAnnotationsValidator />

                <!-- Name -->
                <div class="mb-3">
                    <InputText @bind-Value="registerModel.Name"
                               class="form-control form-control-lg"
                               placeholder="Full Name" />
                    <ValidationMessage For="@(() => registerModel.Name)"
                                       class="text-danger small" />
                </div>

                <!-- Email -->
                <div class="mb-3">
                    <InputText @bind-Value="registerModel.Email"
                               class="form-control form-control-lg"
                               placeholder="Email Address" />
                    <ValidationMessage For="@(() => registerModel.Email)"
                                       class="text-danger small" />
                </div>

                <!-- Password -->
                <div class="mb-4">
                    <InputText @bind-Value="registerModel.Password"
                               type="password"
                               class="form-control form-control-lg"
                               placeholder="Password" />
                    <ValidationMessage For="@(() => registerModel.Password)"
                                       class="text-danger small" />
                </div>

                <!-- Register Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        Register
                    </button>
                </div>
            </EditForm>

            @if (!string.IsNullOrWhiteSpace(Message))
            {
                <div class="alert @(IsSuccess ? "alert-success" : "alert-danger") text-center mt-3">
                    @Message
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnClose { get; set; }

    private Register registerModel = new();
    private string? Message;
    private bool IsSuccess;

    private async Task RegisterAsync()
    {
        Message = null;

        AppResponse? response = await Api.TSendAsync<AppResponse>(
            "api/auth/register",
            registerModel,
            "POST");

        if (response?.Code == 201)
        {
            Notify.Show(response.Message!, response.Code);
        }

        var loginResponse = await Api.TSendAsync<LoginResponse>(
            "api/auth/login",
            new Login
            {
                Email = registerModel.Email,
                Password = registerModel.Password
            },
            "POST");

        if (loginResponse?.Code == 200)
        {
            await LocalStorage.SetItemAsync("token", loginResponse.Token);
            await LocalStorage.SetItemAsync("role", loginResponse.Role);
            await LocalStorage.SetItemAsync("userId", loginResponse.UserId);

            AuthProvider.NotifyUserAuthentication(loginResponse.Token);

            Notify.Show(response?.Message!, response?.Code);
            Nav.NavigateTo("/", forceLoad: true);
        }
        else
        {
            Message = "We are experiencing some technical difficulties. Please try again later.";
            IsSuccess = false;

            await LocalStorage.ClearAsync();
            AuthProvider.NotifyUserLogout();
            Nav.NavigateTo("/", forceLoad: true);
        }
    }
}
