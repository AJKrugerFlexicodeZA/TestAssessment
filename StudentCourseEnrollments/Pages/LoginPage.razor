@page "/login"
@layout EmptyLayout

@using MIDTIER.Models
@using StudentCourseEnrollments.Services

@inject APIService Api
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject JwtAuthenticationStateProvider AuthProvider
@inject NavigationManager Nav
@inject NotificationService Notify

<PageTitle>Login</PageTitle>

<div class="container-fluid vh-100 d-flex align-items-center justify-content-center bg-primary bg-gradient">
    <div class="card shadow-lg border-0" style="max-width: 400px; width: 100%;">
        <div class="card-body p-4">

            <h2 class="text-center mb-4 fw-bold">
                Course Enrollment
            </h2>

            @if (showRegister)
            {
                <RegisterStudent OnClose="CloseRegisterModal" />
            }
            else
            {
                <EditForm Model="loginModel" OnValidSubmit="Login">
                    <DataAnnotationsValidator />
                    <!-- <ValidationSummary class="text-danger mb-3" /> -->

                    <!-- Email -->
                    <div class="mb-3">
                        <InputText @bind-Value="loginModel.Email"
                                   class="form-control form-control-lg"
                                   placeholder="Email" />
                        <ValidationMessage For="@(() => loginModel.Email)"
                                           class="text-danger small" />
                    </div>

                    <!-- Password with show/hide -->
                    <div class="mb-4">
                        <div class="input-group input-group-lg">
                            <input class="form-control"
                                   placeholder="Password"
                                   type="@PasswordInputType"
                                   value="@loginModel.Password"
                                   @oninput="e => loginModel.Password = e.Value?.ToString()" />

                            <button type="button"
                                    class="btn btn-outline-secondary"
                                    @onclick="TogglePassword">
                                <i class="bi @(showPassword ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                        </div>

                        <ValidationMessage For="@(() => loginModel.Password)"
                                           class="text-danger small" />
                    </div>


                    <!-- Login Button -->
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            Login
                        </button>
                    </div>

                    <!-- Register -->
                    <div class="text-center">
                        <span class="text-muted">Don’t have an account?</span>
                        <button type="button"
                                class="btn btn-link fw-semibold p-0 ms-1"
                                @onclick="OpenRegisterModal">
                            Register
                        </button>
                    </div>
                </EditForm>

                @if (!string.IsNullOrWhiteSpace(errorMessage))
                {
                    <div class="alert alert-danger text-center mt-3">
                        @errorMessage
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    private Login loginModel = new();
    private string? errorMessage;
    private bool showRegister = false;

    private bool showPassword = false;
    private string PasswordInputType => showPassword ? "text" : "password";

    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    private void OpenRegisterModal() => showRegister = true;
    private void CloseRegisterModal() => showRegister = false;

    private async Task Login()
    {
        errorMessage = null;

        var response = await Api.TSendAsync<LoginResponse>(
            "api/auth/login",
            loginModel,
            "POST");

        if (response?.Code > 200)
        {
            Notify.Show(response.Message!, response.Code);
            return;
        }

        await LocalStorage.SetItemAsync("token", response?.Token);
        await LocalStorage.SetItemAsync("userId", response?.UserId.ToString());
        await LocalStorage.SetItemAsync("role", response?.Role);
        await LocalStorage.SetItemAsync("name", response?.Name);

        AuthProvider.NotifyUserAuthentication(response?.Token!);
        Notify.Show(response?.Message!, response?.Code);

        await Task.Delay(1000);
        Nav.NavigateTo("/", true);
    }
}
